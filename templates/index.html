<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Viewer</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- LEFT COLUMN: CONTROLS & ERRORS -->
        <div class="left-column">
            <div class="control-panel">
                <div class="panel-title">
                    ‚öôÔ∏è Controls
                </div>
                
                <div class="status-indicator">
                    <span class="status-dot disconnected" id="status-dot"></span>
                    <span class="status-text" id="status-text">Disconnected</span>
                </div>

                <div class="form-group">
                    <label class="form-label">TikTok Username</label>
                    <input type="text" id="username" placeholder="@isaackogz" value="@isaackogz">
                </div>

                <button class="btn btn-primary" id="connect-btn" onclick="connectToStream()">
                    üîó Connect
                </button>
                <button class="btn btn-danger" id="disconnect-btn" onclick="disconnectFromStream()" disabled>
                    ‚õî Disconnect
                </button>

                <div class="form-group" style="margin-top: 24px;">
                    <label class="form-label">Settings</label>
                    <p style="font-size: 0.85rem; color: #9ca3af;">More settings coming soon...</p>
                </div>
            </div>

            <div class="error-container">
                <div class="panel-title" style="margin-bottom: 16px;">
                    üö® Errors & Logs
                </div>
                <div id="error-list"></div>
            </div>
        </div>

        <!-- MIDDLE COLUMN: CHAT -->
        <div class="middle-column">
            <div class="chat-header">
                <h1>üí¨ Live Chat</h1>
                <p class="chat-subtitle">Latest 20 messages</p>
            </div>
            <div class="chat-container" id="chat-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üí≠</div>
                    <div>Waiting for chat messages...</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: EVENTS -->
        <div class="right-column">
            <!-- Notifications (Join, Share, Like) -->
            <div class="event-panel">
                <div class="event-panel-header header-notifications">
                    <span>üîî Notifications</span>
                    <span class="event-counter" id="notification-count">0</span>
                </div>
                <div class="notification-area" id="notification-area">
                    <div class="empty-state" style="position: static;">
                        <div class="empty-state-icon" style="font-size: 3rem;">üîï</div>
                        <div style="font-size: 0.9rem;">No recent activity</div>
                    </div>
                </div>
            </div>

            <!-- Gifts -->
            <div class="event-panel">
                <div class="event-panel-header header-gifts">
                    <span>üéÅ Gifts</span>
                    <span class="event-counter" id="gifts-count">0</span>
                </div>
                <div class="event-list" id="gifts-list">
                    <div class="empty-state">
                        <div class="empty-state-icon" style="font-size: 3rem;">üéÄ</div>
                        <div style="font-size: 0.9rem;">No gifts yet</div>
                    </div>
                </div>
            </div>

            <!-- Follows -->
            <div class="event-panel">
                <div class="event-panel-header header-follows">
                    <span>üë• New Followers</span>
                    <span class="event-counter" id="follows-count">0</span>
                </div>
                <div class="event-list" id="follows-list">
                    <div class="empty-state">
                        <div class="empty-state-icon" style="font-size: 3rem;">üëã</div>
                        <div style="font-size: 0.9rem;">No followers yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        const MAX_CHAT_MESSAGES = 20;
        let notificationTimeouts = [];
        let counters = {
            notifications: 0,
            gifts: 0,
            follows: 0
        };

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addError('WebSocket connection error');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                if (isConnected) {
                    updateConnectionStatus('disconnected');
                }
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');

            dot.className = 'status-dot ' + status;
            
            if (status === 'connected') {
                text.textContent = 'Connected';
                isConnected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status === 'connecting') {
                text.textContent = 'Connecting...';
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;
            } else {
                text.textContent = 'Disconnected';
                isConnected = false;
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function addError(message) {
            const errorList = document.getElementById('error-list');
            const emptyState = errorList.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const errorItem = document.createElement('div');
            errorItem.className = 'error-item';
            
            const time = new Date().toLocaleTimeString();
            errorItem.innerHTML = `
                <div class="error-time">${time}</div>
                <div class="error-message">${escapeHtml(message)}</div>
            `;
            
            errorList.insertBefore(errorItem, errorList.firstChild);

            while (errorList.children.length > 50) {
                errorList.removeChild(errorList.lastChild);
            }
        }

        function updateCounter(type, value) {
            counters[type] = value || counters[type] + 1;
            const counterId = type + '-count';
            const counter = document.getElementById(counterId);
            if (counter) {
                counter.textContent = counters[type];
            }
        }

        function handleEvent(data) {
            switch(data.type) {
                case 'comment':
                    addChatMessage(data);
                    break;
                case 'gift':
                    addGift(data);
                    break;
                case 'follow':
                    addFollow(data);
                    break;
                case 'join':
                case 'share':
                case 'like':
                    addNotification(data);
                    break;
                case 'status':
                    if (data.status === 'connecting') {
                        updateConnectionStatus('connecting');
                    }
                    break;
                case 'system':
                    if (data.message.includes('Connected to @')) {
                        updateConnectionStatus('connected');
                    } else if (data.message.includes('Disconnected')) {
                        updateConnectionStatus('disconnected');
                    }
                    break;
                case 'error':
                    addError(data.message);
                    updateConnectionStatus('disconnected');
                    break;
            }
        }

        function createAvatar(user, avatarUrl) {
            const avatarEl = document.createElement('div');
            avatarEl.className = 'chat-avatar';
            
            if (avatarUrl) {
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.alt = user;
                img.onerror = function() {
                    // Fallback to initial if image fails
                    avatarEl.innerHTML = user.charAt(0).toUpperCase();
                };
                avatarEl.appendChild(img);
            } else {
                avatarEl.textContent = user.charAt(0).toUpperCase();
            }
            
            return avatarEl;
        }

        function addChatMessage(data) {
            const container = document.getElementById('chat-container');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageEl = document.createElement('div');
            messageEl.className = 'chat-message';

            const avatarEl = createAvatar(data.user, data.avatar_url);
            
            const contentEl = document.createElement('div');
            contentEl.className = 'chat-content';
            contentEl.innerHTML = `
                <div class="chat-username">${escapeHtml(data.user)}</div>
                <div class="chat-text">${escapeHtml(data.message)}</div>
            `;

            const iconEl = document.createElement('div');
            iconEl.className = 'chat-icon';
            iconEl.textContent = 'üí¨';

            messageEl.appendChild(avatarEl);
            messageEl.appendChild(contentEl);
            messageEl.appendChild(iconEl);

            container.insertBefore(messageEl, container.firstChild);

            while (container.children.length > MAX_CHAT_MESSAGES) {
                container.removeChild(container.lastChild);
            }
        }

        function addGift(data) {
            const container = document.getElementById('gifts-list');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const giftEl = document.createElement('div');
            giftEl.className = 'event-item event-item-gift';
            
            const avatarEl = document.createElement('div');
            avatarEl.className = 'event-item-avatar';
            if (data.avatar_url) {
                const img = document.createElement('img');
                img.src = data.avatar_url;
                img.alt = data.user;
                img.onerror = function() {
                    avatarEl.innerHTML = data.user.charAt(0).toUpperCase();
                };
                avatarEl.appendChild(img);
            } else {
                avatarEl.textContent = data.user.charAt(0).toUpperCase();
            }

            const contentEl = document.createElement('div');
            contentEl.className = 'event-item-content';
            contentEl.innerHTML = `
                <div class="event-item-user">${escapeHtml(data.user)}</div>
                <div class="event-item-detail">${data.count}x ${escapeHtml(data.gift_name)}</div>
            `;

            giftEl.appendChild(avatarEl);
            giftEl.appendChild(contentEl);

            container.insertBefore(giftEl, container.firstChild);
            updateCounter('gifts');

            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function addFollow(data) {
            const container = document.getElementById('follows-list');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const followEl = document.createElement('div');
            followEl.className = 'event-item event-item-follow';
            
            const avatarEl = document.createElement('div');
            avatarEl.className = 'event-item-avatar';
            if (data.avatar_url) {
                const img = document.createElement('img');
                img.src = data.avatar_url;
                img.alt = data.user;
                img.onerror = function() {
                    avatarEl.innerHTML = data.user.charAt(0).toUpperCase();
                };
                avatarEl.appendChild(img);
            } else {
                avatarEl.textContent = data.user.charAt(0).toUpperCase();
            }

            const contentEl = document.createElement('div');
            contentEl.className = 'event-item-content';
            contentEl.innerHTML = `
                <div class="event-item-user">${escapeHtml(data.user)}</div>
                <div class="event-item-detail">Started following</div>
            `;

            followEl.appendChild(avatarEl);
            followEl.appendChild(contentEl);

            container.insertBefore(followEl, container.firstChild);
            updateCounter('follows');

            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function addNotification(data) {
            const container = document.getElementById('notification-area');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const existing = container.querySelectorAll('.notification-toast');
            existing.forEach(el => el.remove());
            notificationTimeouts.forEach(timeout => clearTimeout(timeout));
            notificationTimeouts = [];

            const toastEl = document.createElement('div');
            let icon, className, message;

            switch(data.type) {
                case 'join':
                    icon = 'üëã';
                    className = 'toast-join';
                    message = 'joined the stream';
                    break;
                case 'share':
                    icon = 'üì§';
                    className = 'toast-share';
                    message = 'shared the stream';
                    break;
                case 'like':
                    icon = '‚ù§Ô∏è';
                    className = 'toast-like';
                    message = `liked (${data.total_likes} total)`;
                    break;
            }

            toastEl.className = `notification-toast ${className}`;
            toastEl.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-user">${escapeHtml(data.user)}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toastEl);
            updateCounter('notifications');

            const timeout = setTimeout(() => {
                toastEl.remove();
            }, 3000);
            notificationTimeouts.push(timeout);
        }

        function connectToStream() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                addError('Please enter a username');
                return;
            }

            updateConnectionStatus('connecting');

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'connect',
                    username: username
                }));
            } else {
                addError('WebSocket not ready. Please wait...');
                updateConnectionStatus('disconnected');
            }
        }

        function disconnectFromStream() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'disconnect'
                }));
            }
            updateConnectionStatus('disconnected');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Connect WebSocket on page load (but don't connect to TikTok)
        connectWebSocket();

        // Allow Enter key to connect
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectToStream();
            }
        });
    </script>
</body>
</html>