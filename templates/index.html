<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Live Contexto Game</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- LEFT COLUMN: CONTROLS & EVENTS -->
        <div class="left-column">
            <div class="control-panel">
                <div class="panel-title">
                    ‚öôÔ∏è Controls
                </div>
                
                <div class="status-indicator">
                    <span class="status-dot disconnected" id="status-dot"></span>
                    <span class="status-text" id="status-text">Disconnected</span>
                </div>

                <div class="form-group">
                    <label class="form-label">TikTok Username</label>
                    <input type="text" id="username" placeholder="@isaackogz" value="@isaackogz">
                </div>

                <button class="btn btn-primary" id="connect-btn" onclick="connectToStream()">
                    üîó Connect
                </button>
                <button class="btn btn-danger" id="disconnect-btn" onclick="disconnectFromStream()" disabled>
                    ‚õî Disconnect
                </button>

                <div class="form-group" style="margin-top: 24px;">
                    <button class="btn btn-warning" onclick="resetGame()">
                        üîÑ Reset Game
                    </button>
                </div>
            </div>

            <!-- Share & Follow Events -->
            <div class="event-panel">
                <div class="event-panel-header header-social">
                    <span>üéâ Social Events</span>
                    <span class="event-counter" id="social-count">0</span>
                </div>
                <div class="event-list social-list" id="social-list">
                    <div class="empty-state">
                        <div class="empty-state-icon" style="font-size: 2rem;">ü§ù</div>
                        <div style="font-size: 0.85rem;">No activity yet</div>
                    </div>
                </div>
            </div>

            <div class="error-container">
                <div class="panel-title" style="margin-bottom: 16px;">
                    üö® Errors & Logs
                </div>
                <div id="error-list"></div>
            </div>
        </div>

        <!-- MIDDLE COLUMN: GAME -->
        <div class="middle-column">
            <div class="game-header">
                <div class="game-title">
                    <span class="game-label">GAME: #</span>
                    <!-- <span class="game-number" id="game-number">----</span> -->
                    <span class="game-number">RANDOM</span>
                </div>
                <div class="game-guesses">
                    <span class="guesses-label">GUESSES:</span>
                    <span class="guesses-count" id="guesses-count">0</span>
                </div>
            </div>

            <div class="game-input-area">
                <input type="text" class="game-input" placeholder="type a word" readonly>
            </div>

            <!-- Notification Area -->
            <div class="notification-popup" id="notification-popup"></div>

            <!-- Guesses Container -->
            <div class="guesses-container" id="guesses-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <div>Waiting for guesses...</div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: HINTS & INFO -->
        <div class="right-column">
            <div class="info-panel">
                <div class="info-header">üìñ How to Play</div>
                <div class="info-content">
                    <p>üéØ Comment words to guess the secret word!</p>
                    <p>üü¢ Green (‚â§499): Very close!</p>
                    <p>üü† Orange (500-1500): Getting there</p>
                    <p>üî¥ Red (>1500): Far away</p>
                    <p>üéÅ Send gifts for hints!</p>
                </div>
            </div>

            <div class="hints-panel">
                <div class="hints-header">üí° Hints</div>
                <div class="hints-list" id="hints-list">
                    <div class="empty-state" style="padding: 30px 20px;">
                        <div class="empty-state-icon" style="font-size: 2.5rem;">üîÆ</div>
                        <div style="font-size: 0.9rem;">Send gifts for hints!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div class="winner-modal" id="winner-modal">
        <div class="winner-content">
            <button class="close-modal" onclick="closeWinnerModal()">‚úï</button>
            <div class="winner-title">üéâ WINNER! üéâ</div>
            <div class="winner-info">
                <div class="winner-avatar" id="winner-avatar"></div>
                <div class="winner-name" id="winner-name"></div>
                <div class="winner-word" id="winner-word"></div>
            </div>
            <div class="leaderboard-title">üèÜ Top 3 Guesses</div>
            <div class="leaderboard" id="leaderboard"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let socialCount = 0;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addError('WebSocket connection error');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                if (isConnected) {
                    updateConnectionStatus('disconnected');
                }
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');

            dot.className = 'status-dot ' + status;
            
            if (status === 'connected') {
                text.textContent = 'Connected';
                isConnected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else if (status === 'connecting') {
                text.textContent = 'Connecting...';
                connectBtn.disabled = true;
                disconnectBtn.disabled = true;
            } else {
                text.textContent = 'Disconnected';
                isConnected = false;
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function addError(message) {
            const errorList = document.getElementById('error-list');
            const errorItem = document.createElement('div');
            errorItem.className = 'error-item';
            
            const time = new Date().toLocaleTimeString();
            errorItem.innerHTML = `
                <div class="error-time">${time}</div>
                <div class="error-message">${escapeHtml(message)}</div>
            `;
            
            errorList.insertBefore(errorItem, errorList.firstChild);

            while (errorList.children.length > 50) {
                errorList.removeChild(errorList.lastChild);
            }
        }

        function handleEvent(data) {
            switch(data.type) {
                case 'game_state':
                case 'game_start':
                    initGame(data);
                    break;
                case 'guess_notification':
                    showGuessNotification(data);
                    break;
                case 'guess_update':
                    updateGuesses(data.guesses);
                    break;
                case 'winner':
                    showWinner(data);
                    break;
                case 'hint':
                    addHint(data);
                    break;
                case 'follow':
                    addSocialEvent(data, 'follow');
                    break;
                case 'share':
                    addSocialEvent(data, 'share');
                    break;
                case 'status':
                    if (data.status === 'connecting') {
                        updateConnectionStatus('connecting');
                    }
                    break;
                case 'system':
                    if (data.message.includes('Connected to @')) {
                        updateConnectionStatus('connected');
                    } else if (data.message.includes('Disconnected')) {
                        updateConnectionStatus('disconnected');
                    }
                    break;
                case 'error':
                    addError(data.message);
                    updateConnectionStatus('disconnected');
                    break;
            }
        }

        function initGame(data) {
            document.getElementById('game-number').textContent = data.game_number || '----';
            document.getElementById('guesses-count').textContent = '0';
            
            // Clear guesses
            const container = document.getElementById('guesses-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <div>Waiting for guesses...</div>
                </div>
            `;
            
            // Clear hints
            const hintsContainer = document.getElementById('hints-list');
            hintsContainer.innerHTML = `
                <div class="empty-state" style="padding: 30px 20px;">
                    <div class="empty-state-icon" style="font-size: 2.5rem;">üîÆ</div>
                    <div style="font-size: 0.9rem;">Send gifts for hints!</div>
                </div>
            `;
            
            if (data.guesses && Object.keys(data.guesses).length > 0) {
                updateGuesses(data.guesses);
            }
        }

        function showGuessNotification(data) {
            const popup = document.getElementById('notification-popup');
            popup.textContent = `${data.user} guessed: ${data.word}`;
            popup.classList.add('show');
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }

        function getDistanceColor(distance) {
            if (distance <= 499) return 'green';
            if (distance <= 1500) return 'orange';
            return 'red';
        }

        function updateGuesses(guesses) {
            const container = document.getElementById('guesses-container');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            // Sort by distance
            const sorted = Object.entries(guesses).sort((a, b) => a[1].distance - b[1].distance);
            
            // Update count
            document.getElementById('guesses-count').textContent = sorted.length;
            
            // Clear and rebuild
            container.innerHTML = '';
            
            sorted.forEach(([word, data]) => {
                const guessEl = document.createElement('div');
                guessEl.className = `guess-item color-${getDistanceColor(data.distance)}`;
                
                // Avatar
                const avatarEl = document.createElement('div');
                avatarEl.className = 'guess-avatar';
                if (data.avatar_url) {
                    const img = document.createElement('img');
                    img.src = data.avatar_url;
                    img.alt = data.user;
                    img.onerror = function() {
                        avatarEl.innerHTML = data.user.charAt(0).toUpperCase();
                    };
                    avatarEl.appendChild(img);
                } else {
                    avatarEl.textContent = data.user.charAt(0).toUpperCase();
                }
                
                // Content
                const contentEl = document.createElement('div');
                contentEl.className = 'guess-content';
                contentEl.innerHTML = `
                    <div class="guess-user">${escapeHtml(data.user)}</div>
                    <div class="guess-word">${escapeHtml(word)}</div>
                `;
                
                // Distance
                const distanceEl = document.createElement('div');
                distanceEl.className = 'guess-distance';
                distanceEl.textContent = data.distance;
                
                guessEl.appendChild(avatarEl);
                guessEl.appendChild(contentEl);
                guessEl.appendChild(distanceEl);
                
                container.appendChild(guessEl);
            });
        }

        function addHint(data) {
            const container = document.getElementById('hints-list');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const hintEl = document.createElement('div');
            hintEl.className = 'hint-item';
            hintEl.innerHTML = `
                <div class="hint-icon">üéÅ</div>
                <div class="hint-content">
                    <div class="hint-word">${escapeHtml(data.word)}</div>
                    <div class="hint-distance">Distance: ${data.distance}</div>
                    <div class="hint-gifter">Thanks to ${escapeHtml(data.gifter)}!</div>
                </div>
            `;
            
            container.insertBefore(hintEl, container.firstChild);
            
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        function showWinner(data) {
            const modal = document.getElementById('winner-modal');
            
            // Winner info
            const avatarEl = document.getElementById('winner-avatar');
            if (data.avatar_url) {
                avatarEl.innerHTML = `<img src="${data.avatar_url}" alt="${data.user}">`;
            } else {
                avatarEl.textContent = data.user.charAt(0).toUpperCase();
            }
            
            document.getElementById('winner-name').textContent = data.user;
            document.getElementById('winner-word').textContent = data.word;
            
            // Leaderboard
            const leaderboard = document.getElementById('leaderboard');
            leaderboard.innerHTML = '';
            
            data.leaderboard.forEach((entry, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'leaderboard-item';
                
                const rankEl = document.createElement('div');
                rankEl.className = 'leaderboard-rank';
                rankEl.textContent = `#${index + 1}`;
                
                const avatarEl = document.createElement('div');
                avatarEl.className = 'leaderboard-avatar';
                if (entry.avatar_url) {
                    const img = document.createElement('img');
                    img.src = entry.avatar_url;
                    img.alt = entry.user;
                    img.onerror = function() {
                        avatarEl.innerHTML = entry.user.charAt(0).toUpperCase();
                    };
                    avatarEl.appendChild(img);
                } else {
                    avatarEl.textContent = entry.user.charAt(0).toUpperCase();
                }
                
                const infoEl = document.createElement('div');
                infoEl.className = 'leaderboard-info';
                infoEl.innerHTML = `
                    <div class="leaderboard-user">${escapeHtml(entry.user)}</div>
                    <div class="leaderboard-word">${escapeHtml(entry.word)}</div>
                `;
                
                const distanceEl = document.createElement('div');
                distanceEl.className = 'leaderboard-distance';
                distanceEl.textContent = entry.distance;
                
                itemEl.appendChild(rankEl);
                itemEl.appendChild(avatarEl);
                itemEl.appendChild(infoEl);
                itemEl.appendChild(distanceEl);
                
                leaderboard.appendChild(itemEl);
            });
            
            modal.classList.add('show');
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                modal.classList.remove('show');
            }, 10000);
        }

        function closeWinnerModal() {
            document.getElementById('winner-modal').classList.remove('show');
        }

        function addSocialEvent(data, type) {
            const container = document.getElementById('social-list');
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            
            const eventEl = document.createElement('div');
            eventEl.className = 'social-item';
            
            const avatarEl = document.createElement('div');
            avatarEl.className = 'social-avatar';
            if (data.avatar_url) {
                const img = document.createElement('img');
                img.src = data.avatar_url;
                img.alt = data.user;
                img.onerror = function() {
                    avatarEl.innerHTML = data.user.charAt(0).toUpperCase();
                };
                avatarEl.appendChild(img);
            } else {
                avatarEl.textContent = data.user.charAt(0).toUpperCase();
            }
            
            const icon = type === 'follow' ? 'üë§' : 'üì§';
            const action = type === 'follow' ? 'followed' : 'shared';
            
            eventEl.innerHTML = `
                ${icon}
                <div class="social-content">
                    <span class="social-user">${escapeHtml(data.user)}</span>
                    <span class="social-action">${action}</span>
                </div>
            `;
            eventEl.insertBefore(avatarEl, eventEl.firstChild);
            
            container.insertBefore(eventEl, container.firstChild);
            
            socialCount++;
            document.getElementById('social-count').textContent = socialCount;
            
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        function connectToStream() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                addError('Please enter a username');
                return;
            }

            updateConnectionStatus('connecting');

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'connect',
                    username: username
                }));
            } else {
                addError('WebSocket not ready. Please wait...');
                updateConnectionStatus('disconnected');
            }
        }

        function disconnectFromStream() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'disconnect'
                }));
            }
            updateConnectionStatus('disconnected');
        }

        function resetGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: 'reset_game'
                }));
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Connect WebSocket on page load
        connectWebSocket();

        // Allow Enter key to connect
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                connectToStream();
            }
        });
    </script>
</body>
</html>